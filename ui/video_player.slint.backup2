import { Button, VerticalBox, HorizontalBox, LineEdit, Slider } from "std-widgets.slint";

export component VideoPlayerUI inherits Window {
    title: "Video Player";
    preferred-width: 1300px;
    preferred-height: 700px;
    
    // „Éó„É≠„Éë„ÉÜ„Ç£
    in-out property <string> video-path: "";
    in-out property <int> repeat-count: 1;
    in-out property <float> current-time: 0.0;
    in-out property <float> duration: 0.0;
    in-out property <bool> is-playing: false;
    in-out property <image> video-frame;
    in-out property <float> volume: 1.0; // 0.0 ~ 1.0
    in-out property <bool> fullscreen-mode: false;
    
    // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
    callback select-video();
    callback play-pause();
    callback stop();
    callback seek(float);
    callback repeat-changed(int);
    callback volume-changed(float);
    
    // „Ç≠„ÉºÂÖ•Âäõ„ÇíÊçïÊçâ„Åô„Çã„Åü„ÇÅ„ÅÆFocusScope
    FocusScope {
        width: 100%;
        height: 100%;
        
        key-pressed(event) => {
            // Ctrl + Alt „ÅßÂÖ®ÁîªÈù¢Âàá„ÇäÊõø„Åà
            if (event.text == "" && event.modifiers.control && event.modifiers.alt) {
                fullscreen-mode = !fullscreen-mode;
                return accept;
            }
            // Escape „ÅßÂÖ®ÁîªÈù¢Ëß£Èô§
            if (event.text == "\u{1b}" && fullscreen-mode) {
                fullscreen-mode = false;
                return accept;
            }
            return reject;
        }
        
        // ÈÄöÂ∏∏„É¢„Éº„Éâ
        if !fullscreen-mode: VerticalBox {
        padding: 20px;
        spacing: 10px;
        
        // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢
        HorizontalBox {
            spacing: 20px;
            
            // ÂãïÁîªË°®Á§∫„Ç®„É™„Ç¢ÔºàÂ∑¶ÂÅ¥„Éª960x600Âõ∫ÂÆöÔºâ
            Rectangle {
                width: 960px;
                height: 600px;
                background: #000000;
                border-width: 2px;
                border-color: #333333;
                border-radius: 8px;
                
                if video-frame.width > 0: Image {
                    source: video-frame;
                    width: 100%;
                    height: 100%;
                    image-fit: contain;
                }
                
                if video-frame.width == 0: Text {
                    text: video-path == "" ? "ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" : "ÂãïÁîªÊ∫ñÂÇô‰∏≠...";
                    color: #ffffff;
                    font-size: 20px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            // „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ÔºàÂè≥ÂÅ¥Ôºâ
            VerticalBox {
                spacing: 12px;
                width: 280px;
                
                // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Ç®„É™„Ç¢
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "ÂãïÁîª„Éï„Ç°„Ç§„É´";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    Rectangle {
                        border-width: 1px;
                        border-color: #cccccc;
                        border-radius: 4px;
                        background: white;
                        height: 40px;
                        
                        VerticalLayout {
                            padding: 6px;
                            
                            Text {
                                text: video-path == "" ? "Êú™ÈÅ∏Êäû" : video-path;
                                vertical-alignment: center;
                                horizontal-alignment: left;
                                color: video-path == "" ? #999999 : #000000;
                                overflow: elide;
                                font-size: 11px;
                            }
                        }
                    }
                    
                    Button {
                        text: "üìÅ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû...";
                        clicked => {
                            select-video();
                        }
                    }
                }
                
                // „É™„Éî„Éº„ÉàÂõûÊï∞Ë®≠ÂÆö„Ç®„É™„Ç¢
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "„É™„Éî„Éº„ÉàÂõûÊï∞";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    HorizontalBox {
                        spacing: 8px;
                        
                        Button {
                            text: "-";
                            width: 45px;
                            clicked => {
                                if (repeat-count > 1) {
                                    repeat-count -= 1;
                                    repeat-changed(repeat-count);
                                }
                            }
                        }
                        
                        LineEdit {
                            text: repeat-count == -1 ? "‚àû" : repeat-count;
                            horizontal-stretch: 1;
                            horizontal-alignment: center;
                            edited(new-text) => {
                                if (new-text == "‚àû") {
                                    repeat-count = -1;
                                } else {
                                    repeat-count = new-text.to-float();
                                }
                                repeat-changed(repeat-count);
                            }
                        }
                        
                        Button {
                            text: "+";
                            width: 45px;
                            clicked => {
                                if (repeat-count == -1) {
                                    repeat-count = 1;
                                }
                                repeat-count += 1;
                                repeat-changed(repeat-count);
                            }
                        }
                    }
                    
                    Button {
                        text: "‚àû ÁÑ°Èôê„É™„Éî„Éº„Éà";
                        clicked => {
                            repeat-count = -1;
                            repeat-changed(repeat-count);
                        }
                    }
                }
                
                // „Éú„É™„É•„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "Èü≥Èáè";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    HorizontalBox {
                        spacing: 10px;
                        alignment: center;
                        
                        Text {
                            text: volume == 0 ? "üîá" : volume < 0.5 ? "üîâ" : "üîä";
                            font-size: 20px;
                            width: 30px;
                        }
                        
                        Slider {
                            minimum: 0;
                            maximum: 1;
                            value: volume;
                            changed(new-value) => {
                                volume = new-value;
                                volume-changed(new-value);
                            }
                        }
                        
                        Text {
                            text: Math.round(volume * 100) + "%";
                            font-size: 12px;
                            width: 45px;
                            horizontal-alignment: right;
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "0%";
                            width: 60px;
                            clicked => {
                                volume = 0.0;
                                volume-changed(volume);
                            }
                        }
                        
                        Button {
                            text: "50%";
                            width: 60px;
                            clicked => {
                                volume = 0.5;
                                volume-changed(volume);
                            }
                        }
                        
                        Button {
                            text: "100%";
                            width: 60px;
                            clicked => {
                                volume = 1.0;
                                volume-changed(volume);
                            }
                        }
                    }
                }
                
                // ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    Button {
                        text: is-playing ? "‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢" : "‚ñ∂ ÂÜçÁîü";
                        primary: true;
                        clicked => {
                            play-pause();
                        }
                    }
                    
                    Button {
                        text: "‚èπ ÂÅúÊ≠¢";
                        clicked => {
                            stop();
                        }
                    }
                }
                
                // ÊÉÖÂ†±Ë°®Á§∫
                Rectangle {
                    border-width: 1px;
                    border-color: #e0e0e0;
                    border-radius: 4px;
                    background: #f5f5f5;
                    padding: 12px;
                    
                    VerticalBox {
                        spacing: 5px;
                        
                        Text {
                            text: "„Çπ„ÉÜ„Éº„Çø„Çπ";
                            font-size: 14px;
                            font-weight: 700;
                        }
                        
                        Text {
                            text: is-playing ? "‚ñ∂ ÂÜçÁîü‰∏≠" : "‚è∏ ÂÅúÊ≠¢";
                            color: is-playing ? #00aa00 : #666666;
                            font-size: 13px;
                        }
                        
                        Text {
                            text: "ÊôÇÈñì: " + format-time(current-time) + " / " + format-time(duration);
                            color: #666666;
                            font-size: 12px;
                        }
                        
                        Text {
                            text: repeat-count == -1 ? "„É™„Éî„Éº„Éà: ÁÑ°Èôê" : "„É™„Éî„Éº„Éà: " + repeat-count + "Âõû";
                            color: #666666;
                            font-size: 12px;
                        }
                    }
                }
                
                Rectangle {
                    vertical-stretch: 1;
                }
            }
        }
        
        // „Ç∑„Éº„ÇØ„Éê„Éº
        Rectangle {
            background: #f8f8f8;
            border-radius: 6px;
            padding: 10px;
            
            HorizontalBox {
                spacing: 12px;
                
                Text {
                    text: format-time(current-time);
                    width: 60px;
                    vertical-alignment: center;
                    font-size: 14px;
                    font-weight: 600;
                    color: #333333;
                }
                
                Slider {
                    horizontal-stretch: 1;
                    minimum: 0;
                    maximum: duration > 0 ? duration : 100;
                    value: current-time;
                    changed(new-value) => {
                        seek(new-value);
                    }
                }
                
                Text {
                    text: format-time(duration);
                    width: 60px;
                    vertical-alignment: center;
                    horizontal-alignment: right;
                    font-size: 14px;
                    font-weight: 600;
                    color: #333333;
                }
            }
        }
    }
        
        // ÂÖ®ÁîªÈù¢„É¢„Éº„Éâ
        if fullscreen-mode: Rectangle {
            width: 100%;
            height: 100%;
            background: #000000;
            
            VerticalLayout {
                padding: 0px;
                spacing: 0px;
                
                // ÂãïÁîªË°®Á§∫„Ç®„É™„Ç¢ÔºàÂÖ®ÁîªÈù¢„ÅÆÂ§ßÈÉ®ÂàÜÔºâ
                Rectangle {
                    vertical-stretch: 1;
                    background: #000000;
                    
                    if video-frame.width > 0: Image {
                        source: video-frame;
                        width: 100%;
                        height: 100%;
                        image-fit: contain;
                    }
                    
                    if video-frame.width == 0: Text {
                        text: video-path == "" ? "ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" : "ÂãïÁîªÊ∫ñÂÇô‰∏≠...";
                        color: #ffffff;
                        font-size: 28px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                // ‰∏ãÈÉ®„Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢
                Rectangle {
                    background: rgba(0, 0, 0, 0.85);
                    height: 120px;
                    
                    VerticalLayout {
                        padding: 20px;
                        spacing: 15px;
                        
                        // „Ç∑„Éº„ÇØ„Éê„Éº
                        HorizontalBox {
                            spacing: 15px;
                            
                            Text {
                                text: format-time(current-time);
                                width: 70px;
                                vertical-alignment: center;
                                font-size: 16px;
                                font-weight: 600;
                                color: #ffffff;
                            }
                            
                            Slider {
                                horizontal-stretch: 1;
                                minimum: 0;
                                maximum: duration > 0 ? duration : 100;
                                value: current-time;
                                changed(new-value) => {
                                    seek(new-value);
                                }
                            }
                            
                            Text {
                                text: format-time(duration);
                                width: 70px;
                                vertical-alignment: center;
                                horizontal-alignment: right;
                                font-size: 16px;
                                font-weight: 600;
                                color: #ffffff;
                            }
                        }
                        
                        // Èü≥Èáè„Éê„Éº
                        HorizontalBox {
                            spacing: 15px;
                            alignment: center;
                            
                            Text {
                                text: volume == 0 ? "üîá" : volume < 0.5 ? "üîâ" : "üîä";
                                font-size: 24px;
                                width: 40px;
                            }
                            
                            Text {
                                text: "Èü≥Èáè:";
                                color: #ffffff;
                                font-size: 14px;
                                width: 50px;
                            }
                            
                            Slider {
                                horizontal-stretch: 1;
                                minimum: 0;
                                maximum: 1;
                                value: volume;
                                changed(new-value) => {
                                    volume = new-value;
                                    volume-changed(new-value);
                                }
                            }
                            
                            Text {
                                text: Math.round(volume * 100) + "%";
                                font-size: 14px;
                                width: 60px;
                                horizontal-alignment: right;
                                color: #ffffff;
                            }
                            
                            Text {
                                text: "Esc: ÁµÇ‰∫Ü";
                                font-size: 12px;
                                color: #aaaaaa;
                                width: 80px;
                                horizontal-alignment: right;
                            }
                        }
                    }
                }
            }
        }
    }
    
    // ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
    pure function format-time(seconds: float) -> string {
        Math.floor(seconds / 60) + ":" + 
        (Math.floor(Math.mod(seconds, 60)) < 10 ? "0" : "") + 
        Math.floor(Math.mod(seconds, 60))
    }
}
