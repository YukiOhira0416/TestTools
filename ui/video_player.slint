import { Button, VerticalBox, HorizontalBox, LineEdit, Slider } from "std-widgets.slint";

// 全画面用の白ベーススライダー
component WhiteSlider inherits Rectangle {
    in-out property <float> value: 0;
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    in property <bool> enabled: true;
    callback changed(float);

    height: 24px;

    property <float> range: root.maximum - root.minimum;
    property <float> ratio: root.range > 0 ? Math.max(0, Math.min(1, (root.value - root.minimum) / root.range)) : 0;

    // トラック背景（暗めグレー）
    Rectangle {
        x: 0;
        y: (parent.height - 6px) / 2;
        width: parent.width;
        height: 6px;
        border-radius: 3px;
        background: #555555;

        // 進行部分（白）
        Rectangle {
            x: 0;
            width: parent.width * root.ratio;
            height: parent.height;
            border-radius: 3px;
            background: #ffffff;
        }
    }

    // ハンドル（白い丸）
    Rectangle {
        x: (root.width - self.width) * root.ratio;
        y: (root.height - self.height) / 2;
        width: 16px;
        height: 16px;
        border-radius: 8px;
        background: #ffffff;
        border-width: 1px;
        border-color: #aaaaaa;
    }

    // タッチ操作エリア
    touch := TouchArea {
        width: root.width;
        height: root.height;

        pointer-event(event) => {
            if event.kind == PointerEventKind.down && root.enabled {
                root.value = root.minimum + root.range * Math.max(0, Math.min(1, self.mouse-x / root.width));
                root.changed(root.value);
            }
        }

        moved => {
            if self.pressed && root.enabled {
                root.value = root.minimum + root.range * Math.max(0, Math.min(1, self.mouse-x / root.width));
                root.changed(root.value);
            }
        }
    }
}

export component VideoPlayerUI inherits Window {
    title: "Video Player";
    preferred-width: 1360px;
    preferred-height: 700px;
    // リサイズ不可（固定サイズ）
    min-width: 1360px;
    max-width: 1360px;
    min-height: 700px;
    max-height: 700px;
    
    // プロパティ
    in-out property <string> video-path: "";
    in-out property <int> repeat-count: 1;
    in-out property <float> current-time: 0.0;
    in-out property <float> duration: 0.0;
    in-out property <bool> is-playing: false;
    in-out property <image> video-frame;
    in-out property <float> volume: 1.0; // 0.0 ~ 1.0
    in-out property <bool> fullscreen-mode: false;
    
    // コールバック
    callback select-video();
    callback play-pause();
    callback stop();
    callback seek(float);
    callback repeat-changed(int);
    callback volume-changed(float);
    
    // 通常モード
    if !fullscreen-mode: VerticalBox {
        padding: 20px;
        spacing: 10px;
        
        // メインコンテンツエリア
        HorizontalBox {
            spacing: 20px;
            
            // 左側：動画表示エリアとコントロール
            VerticalBox {
                spacing: 10px;
                
                // 動画表示エリア（960x600固定）
                Rectangle {
                    width: 960px;
                    height: 600px;
                    background: #000000;
                    border-width: 2px;
                    border-color: #333333;
                    border-radius: 8px;
                    
                    if video-frame.width > 0: Image {
                        source: video-frame;
                        width: 100%;
                        height: 100%;
                        image-fit: contain;
                    }
                    
                    if video-frame.width == 0: Text {
                        text: video-path == "" ? "動画ファイルを選択してください" : "動画準備中...";
                        color: #ffffff;
                        font-size: 20px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                // シークバー
                Rectangle {
                    width: 960px;
                    background: #f8f8f8;
                    border-radius: 6px;
                    
                    HorizontalBox {
                        padding: 10px;
                        spacing: 12px;
                        
                        Text {
                            text: format-time(current-time);
                            width: 60px;
                            vertical-alignment: center;
                            font-size: 14px;
                            font-weight: 600;
                            color: #333333;
                        }
                        
                        Slider {
                            horizontal-stretch: 1;
                            minimum: 0;
                            maximum: duration > 0 ? duration : 100;
                            value <=> current-time;
                            changed(new-value) => {
                                seek(new-value);
                            }
                        }
                        
                        Text {
                            text: format-time(duration);
                            width: 60px;
                            vertical-alignment: center;
                            horizontal-alignment: right;
                            font-size: 14px;
                            font-weight: 600;
                            color: #333333;
                        }
                    }
                }
            }
            
            // コントロールパネル（右側）
            VerticalBox {
                spacing: 12px;
                width: 280px;
                
                // ファイル選択エリア
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "動画ファイル";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    Rectangle {
                        border-width: 1px;
                        border-color: #cccccc;
                        border-radius: 4px;
                        background: white;
                        height: 40px;
                        
                        VerticalLayout {
                            padding: 6px;
                            
                            Text {
                                text: video-path == "" ? "未選択" : video-path;
                                vertical-alignment: center;
                                horizontal-alignment: left;
                                color: video-path == "" ? #999999 : #000000;
                                overflow: elide;
                                font-size: 11px;
                            }
                        }
                    }
                    
                    Button {
                        text: " ファイルを選択...";
                        clicked => {
                            select-video();
                        }
                    }
                }
                
                // リピート回数設定エリア
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "リピート回数";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    HorizontalBox {
                        spacing: 8px;
                        
                        Button {
                            text: "-";
                            width: 45px;
                            clicked => {
                                if (repeat-count > 1) {
                                    repeat-count -= 1;
                                    repeat-changed(repeat-count);
                                }
                            }
                        }
                        
                        LineEdit {
                            text: repeat-count == -1 ? "" : repeat-count;
                            horizontal-stretch: 1;
                            horizontal-alignment: center;
                            edited(new-text) => {
                                if (new-text == "") {
                                    repeat-count = -1;
                                } else {
                                    repeat-count = new-text.to-float();
                                }
                                repeat-changed(repeat-count);
                            }
                        }
                        
                        Button {
                            text: "+";
                            width: 45px;
                            clicked => {
                                if (repeat-count == -1) {
                                    repeat-count = 1;
                                }
                                repeat-count += 1;
                                repeat-changed(repeat-count);
                            }
                        }
                    }
                    
                    Button {
                        text: " 無限リピート";
                        clicked => {
                            repeat-count = -1;
                            repeat-changed(repeat-count);
                        }
                    }
                }
                
                // 音量コントロール
                Rectangle {
                    border-width: 1px;
                    border-color: #000000;
                    border-radius: 6px;
                    background: #ffffff;
                    
                    VerticalLayout {
                        padding: 12px;
                        spacing: 8px;
                        
                        Text {
                            text: "音量";
                            font-size: 16px;
                            font-weight: 700;
                        }
                        
                        HorizontalBox {
                            spacing: 10px;
                            
                            Text {
                                text: volume == 0 ? "🔇" : volume < 0.5 ? "🔉" : "🔊";
                                font-size: 20px;
                                width: 30px;
                                vertical-alignment: center;
                            }
                            
                            Slider {
                                horizontal-stretch: 1;
                                height: 24px;
                                minimum: 0;
                                maximum: 100;
                                value: Math.round(volume * 100);
                                enabled: true;
                                changed(new-value) => {
                                    volume = new-value / 100;
                                    volume-changed(volume);
                                }
                            }
                            
                            Text {
                                text: Math.round(volume * 100) + "%";
                                font-size: 14px;
                                font-weight: 700;
                                width: 50px;
                                horizontal-alignment: right;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
                
                // 再生コントロール
                VerticalBox {
                    spacing: 4px;
                    
                    Text {
                        text: "再生コントロール";
                        font-size: 16px;
                        font-weight: 700;
                    }
                    
                    Button {
                        text: is-playing ? " 一時停止" : " 再生";
                        primary: true;
                        clicked => {
                            play-pause();
                        }
                    }
                    
                    Button {
                        text: " 停止";
                        clicked => {
                            stop();
                        }
                    }
                }
                
                // 情報表示
                Rectangle {
                    border-width: 1px;
                    border-color: #e0e0e0;
                    border-radius: 4px;
                    background: #f5f5f5;
                    padding: 12px;
                    
                    VerticalBox {
                        spacing: 5px;
                        
                        Text {
                            text: "ステータス";
                            font-size: 14px;
                            font-weight: 700;
                        }
                        
                        Text {
                            text: is-playing ? " 再生中" : " 停止";
                            color: is-playing ? #00aa00 : #666666;
                            font-size: 13px;
                        }
                        
                        Text {
                            text: "時間: " + format-time(current-time) + " / " + format-time(duration);
                            color: #666666;
                            font-size: 12px;
                        }
                        
                        Text {
                            text: repeat-count == -1 ? "リピート: 無限" : "リピート: " + repeat-count + "回";
                            color: #666666;
                            font-size: 12px;
                        }
                    }
                }
                
                Rectangle {
                    vertical-stretch: 1;
                }
            }
        }
    }
    
    // 全画面モード
    if fullscreen-mode: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000;
        
        VerticalLayout {
            padding: 0px;
            spacing: 0px;
            
            // 動画表示エリア（アスペクト比維持）
            Rectangle {
                vertical-stretch: 1;
                background: #000000;
                
                if video-frame.width > 0: Image {
                    source: video-frame;
                    width: 95%;
                    height: 95%;
                    image-fit: contain;
                }
                
                if video-frame.width == 0: Text {
                    text: video-path == "" ? "動画ファイルを選択してください" : "動画準備中...";
                    color: #ffffff;
                    font-size: 28px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            // 下部コントロールエリア
            Rectangle {
                background: rgba(0, 0, 0, 0.85);
                height: 110px;
                
                VerticalLayout {
                    padding-left: 15px;
                    padding-right: 15px;
                    padding-top: 8px;
                    padding-bottom: 8px;
                    spacing: 4px;
                    
                    // シークバー
                    HorizontalBox {
                        spacing: 15px;
                        
                        Text {
                            text: format-time(current-time);
                            width: 70px;
                            vertical-alignment: center;
                            font-size: 16px;
                            font-weight: 600;
                            color: #ffffff;
                        }
                        
                        WhiteSlider {
                            horizontal-stretch: 1;
                            minimum: 0;
                            maximum: duration > 0 ? duration : 100;
                            value <=> current-time;
                            changed(new-value) => {
                                seek(new-value);
                            }
                        }
                        
                        Text {
                            text: format-time(duration);
                            width: 70px;
                            vertical-alignment: center;
                            horizontal-alignment: right;
                            font-size: 16px;
                            font-weight: 600;
                            color: #ffffff;
                        }
                    }
                    
                    // 音量バー（左）+ 再生・停止ボタン（画面中央）を同じ行に
                    HorizontalBox {
                        spacing: 10px;
                        
                        // 音量バー（左側）
                        Text {
                            text: "音量:";
                            color: #ffffff;
                            font-size: 14px;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: volume == 0 ? "🔇" : volume < 0.5 ? "🔉" : "🔊";
                            font-size: 18px;
                            vertical-alignment: center;
                        }
                        
                        WhiteSlider {
                            width: 200px;
                            height: 24px;
                            minimum: 0;
                            maximum: 100;
                            value: Math.round(volume * 100);
                            enabled: true;
                            changed(new-value) => {
                                volume = new-value / 100;
                                volume-changed(volume);
                            }
                        }
                        
                        Text {
                            text: Math.round(volume * 100) + "%";
                            font-size: 13px;
                            width: 50px;
                            horizontal-alignment: right;
                            color: #ffffff;
                            vertical-alignment: center;
                        }
                        
                        // スペーサー（ボタンを画面中央へ）
                        Rectangle {
                            horizontal-stretch: 1;
                        }
                        
                        // 再生・停止ボタン（画面中央）
                        Rectangle {
                            width: 120px;
                            height: 40px;
                            border-radius: 6px;
                            background: #2060d0;
                            
                            Text {
                                text: is-playing ? "⏸ 一時停止" : "▶ 再生";
                                color: #ffffff;
                                font-size: 14px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            
                            TouchArea {
                                clicked => {
                                    play-pause();
                                }
                            }
                        }
                        
                        Rectangle {
                            width: 120px;
                            height: 40px;
                            border-radius: 6px;
                            background: #444444;
                            
                            Text {
                                text: "⏹ 停止";
                                color: #ffffff;
                                font-size: 14px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            
                            TouchArea {
                                clicked => {
                                    stop();
                                }
                            }
                        }
                        
                        // 右スペーサー（音量バー分のオフセットで中央補正）
                        Rectangle {
                            horizontal-stretch: 1;
                            min-width: 320px;
                        }
                    }
                }
            }
            
            // 下部余白（全体を上に持ち上げる）
            Rectangle {
                height: 30px;
                background: #000000;
            }
        }
    }
    
    // 時間フォーマット関数
    pure function format-time(seconds: float) -> string {
        Math.floor(seconds / 60) + ":" + 
        (Math.floor(Math.mod(seconds, 60)) < 10 ? "0" : "") + 
        Math.floor(Math.mod(seconds, 60))
    }
}
